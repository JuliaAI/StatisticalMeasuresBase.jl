<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · StatisticalMeasuresBase.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">StatisticalMeasuresBase.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#The-basics"><span>The basics</span></a></li><li><a class="tocitem" href="#Overloading-traits"><span>Overloading traits</span></a></li><li><a class="tocitem" href="#Improving-display-of-measures"><span>Improving display of measures</span></a></li><li><a class="tocitem" href="#Macro-shortcut-(experimental)"><span>Macro shortcut (experimental)</span></a></li></ul></li><li><a class="tocitem" href="../methods/">Methods</a></li><li><a class="tocitem" href="../implementing_new_measures/">Implementing New Measures</a></li><li><a class="tocitem" href="../tools_for_implementers/">Tools for Implementers</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaAI/StatisticalMeasuresBase.jl/blob/dev/docs/src/tutorial.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial"><a class="docs-heading-anchor" href="#Tutorial">Tutorial</a><a id="Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial" title="Permalink"></a></h1><p>Read this tutorial to learn how to implement new measures using StatisticalMeasuresBase.jl. Refer to <a href="../implementing_new_measures/#Implementing-New-Measures">Implementing New Measures</a> and other sections for technical details, bells and whistles.</p><p>The goal of this tutorial is to define a <a href="https://en.wikipedia.org/wiki/Huber_loss">Huber loss function</a>, <code>HuberLoss(; delta=1)</code>, that consumes vectors of real ground truth observations/predictions, with support for weights, class weights and missing values; and a second measure <code>MultitargetHuberLoss(; delta=1)</code> that consumes matrices, tables or multidimensional arrays. To do so requires only that we implement a single Huber loss for scalars and apply appropriate measure <a href="../methods/#wrappers">wrappers</a>.</p><p>As we&#39;ll see, the most important wrapper to understand is the <a href="../methods/#StatisticalMeasuresBase.multimeasure"><code>multimeasure</code></a> wrapper.</p><h2 id="The-basics"><a class="docs-heading-anchor" href="#The-basics">The basics</a><a id="The-basics-1"></a><a class="docs-heading-anchor-permalink" href="#The-basics" title="Permalink"></a></h2><p>Let&#39;s start by defining a scalar <a href="https://en.wikipedia.org/wiki/Huber_loss">Huber loss function</a>:</p><pre><code class="language-julia hljs">valley(a, delta=1) = abs(a) &lt;= delta ? a^2/2 : delta*(abs(a) - delta/2)
huber(ŷ, y, delta=1) = valley(ŷ - y, delta)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">huber (generic function with 2 methods)</code></pre><h4 id="Huber-loss-type-for-scalar-input"><a class="docs-heading-anchor" href="#Huber-loss-type-for-scalar-input">Huber loss type for scalar input</a><a id="Huber-loss-type-for-scalar-input-1"></a><a class="docs-heading-anchor-permalink" href="#Huber-loss-type-for-scalar-input" title="Permalink"></a></h4><p>Since the Huber loss has a parameter, we create a struct, and make instances callable:</p><pre><code class="language-julia hljs">using StatisticalMeasuresBase
import StatisticalMeasuresBase as API

struct HuberLossOnScalars{T&lt;:Real}
    delta::T
end
(measure::HuberLossOnScalars)(ŷ, y) = huber(ŷ, y, measure.delta)
API.is_measure(::HuberLossOnScalars) = true # recommended if `HuberLossOnScalars` is public-facing</code></pre><pre><code class="language-julia hljs">measure = HuberLossOnScalars(0.5)
@assert measure(7, 4) == huber(7, 4, 0.5)</code></pre><h4 id="Huber-loss-for-vector-input"><a class="docs-heading-anchor" href="#Huber-loss-for-vector-input">Huber loss for vector input</a><a id="Huber-loss-for-vector-input-1"></a><a class="docs-heading-anchor-permalink" href="#Huber-loss-for-vector-input" title="Permalink"></a></h4><p>To get a Huber loss for vectors, we wrap the scalar measure using <a href="../methods/#StatisticalMeasuresBase.multimeasure"><code>multimeasure</code></a>, which broadcasts over <code>MLUtils.eachobs((ŷ, y))</code> in <code>call</code> invocations. We also include a preliminary wrapping to support <code>missing</code> values:</p><pre><code class="language-julia hljs">HuberLoss(delta) =
    multimeasure(supports_missings_measure(HuberLossOnScalars(delta)))
HuberLoss(; delta=1) = HuberLoss(delta)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">HuberLoss (generic function with 2 methods)</code></pre><p>By default, a new measure has <code>Mean()</code> as its <em>external aggregation mode</em>, which you can inspect using the trait <a href="../methods/#StatisticalMeasuresBase.external_aggregation_mode"><code>StatisticalMeasuresBase.external_aggregation_mode(measure)</code></a>. Wrappers, like <code>support_missings_measure</code>, forward such traits to the wrapped measure. The <a href="../methods/#StatisticalMeasuresBase.multimeasure"><code>multimeasure</code></a> wrapper uses <a href="https://github.com/JuliaML/MLUtils.jl">MLUtils.jl</a>&#39;s <code>eachobs</code> method to broadcast the atomic measure over oberservations and, by default, aggregates the result using the atomic measure&#39;s aggregation mode.</p><h4 id="Demonstration"><a class="docs-heading-anchor" href="#Demonstration">Demonstration</a><a id="Demonstration-1"></a><a class="docs-heading-anchor-permalink" href="#Demonstration" title="Permalink"></a></h4><pre><code class="language-julia hljs">using Statistics
ŷ = [1, 2, missing]
y = [7, 4, 6]
weights = [1, 3, 2]
class_weights = Dict(7=&gt;3.0, 4=&gt;4.0, 6=&gt;2.0)

wts = weights .* (class_weights[η] for η in y)
@assert HuberLoss(1)(ŷ, y, weights, class_weights) ≈
    sum(wts[1:2] .* huber.(ŷ[1:2], y[1:2])) / length(wts)</code></pre><p>Note the divisor <code>length(weights)</code> on the last line: The weighted measurement is not literally the <a href="https://en.wikipedia.org/wiki/Arithmetic_mean">weighted mean</a> but the weighted mean scaled by the average value of the weights. To get the bone fide weighted mean, use <code>multimeasure(..., mode=IMean())</code> instead. Another option is <code>Sum()</code>; see <a href="../methods/#StatisticalMeasuresBase.AggregationMode"><code>StatisticalMeasuresBase.AggregationMode</code></a> for other options.</p><h4 id="Multi-target-Huber-loss"><a class="docs-heading-anchor" href="#Multi-target-Huber-loss">Multi-target Huber loss</a><a id="Multi-target-Huber-loss-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-target-Huber-loss" title="Permalink"></a></h4><p>Here&#39;s the Huber loss for multi-targets (matrices or tables) which includes strict argument checks, and works for higher dimensional arrays as well (argument checks can be removed with <a href="../methods/#StatisticalMeasuresBase.unfussy"><code>unfussy(measure)</code></a>):</p><pre><code class="language-julia hljs">MultitargetHuberLoss(args...; kwargs...) =
    multimeasure(HuberLoss(args...; kwargs...), transform = vec∘collect) |&gt; fussy_measure</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">MultitargetHuberLoss (generic function with 1 method)</code></pre><h4 id="Demonstration-2"><a class="docs-heading-anchor" href="#Demonstration-2">Demonstration</a><a class="docs-heading-anchor-permalink" href="#Demonstration-2" title="Permalink"></a></h4><p>Multi-targets (as matrices):</p><pre><code class="language-julia hljs">y       = rand(3, 20)
ŷ       = rand(3, 20)
weights = rand(20)
ms = weights .* vec(mean(huber.(ŷ, y), dims=1))
@assert measurements(MultitargetHuberLoss(), ŷ, y, weights) ≈ ms
@assert MultitargetHuberLoss()(ŷ, y, weights) ≈  sum(ms)/length(weights)</code></pre><p>Note the use of the <code>measurements</code> method, to return one measurement per observation, instead of an aggregate.</p><p>Mutli-targets (as tables):</p><pre><code class="language-julia hljs">using DataFrames
df    = DataFrame(y&#39;, :auto)
df̂    = DataFrame(ŷ&#39;, :auto)
@assert MultitargetHuberLoss()(df̂, df, weights) ≈ MultitargetHuberLoss()(df̂, df, weights)</code></pre><p>Multi-dimensional arrays:</p><pre><code class="language-julia hljs">y    = rand(2, 3, 20)
ŷ    = rand(2, 3, 20)
weights = rand(20)
ms = weights .* vec(mean(huber.(ŷ, y), dims=[1, 2]))
@assert measurements(MultitargetHuberLoss(), ŷ, y, weights) ≈ ms
@assert MultitargetHuberLoss()(ŷ, y, weights) ≈  sum(ms)/length(weights)</code></pre><p>Invalid arguments:</p><pre><code class="language-julia hljs">class_weights = Dict()
MultitargetHuberLoss()(ŷ, y, class_weights)
ERROR: ArgumentError: Class pool or value set is not compatible with the class_weight dictionary keys.</code></pre><h2 id="Overloading-traits"><a class="docs-heading-anchor" href="#Overloading-traits">Overloading traits</a><a id="Overloading-traits-1"></a><a class="docs-heading-anchor-permalink" href="#Overloading-traits" title="Permalink"></a></h2><p>Here&#39;s how to overload <a href="../implementing_new_measures/#traits">measure traits</a> to make additional promises of behavior.</p><pre><code class="language-julia hljs">using ScientificTypesBase
@trait HuberLossOnScalars orientation=Loss()

typeof(HuberLoss())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">StatisticalMeasuresBase.Multimeasure{StatisticalMeasuresBase.SupportsMissingsMeasure{Main.HuberLossOnScalars{Int64}}, Nothing, Mean, typeof(identity)}</code></pre><pre><code class="language-julia hljs">const HuberLossType = API.Multimeasure{
    &lt;:API.SupportsMissingsMeasure{
    &lt;:HuberLossOnScalars
}}
@trait(
    HuberLossType,
    observation_scitype = Union{Continuous,Missing},
    human_name = &quot;Huber loss&quot;,
)

API.observation_scitype(HuberLoss())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Union{Missing, ScientificTypesBase.Continuous}</code></pre><pre><code class="language-julia hljs">const MultitargetHuberLossType = API.FussyMeasure{&lt;:API.Multimeasure{&lt;:HuberLossType}}
@trait(
    MultitargetHuberLossType,
    observation_scitype = AbstractArray{&lt;:Union{Continuous,Missing}},
    can_consume_tables = true,
    human_name = &quot;multi-target Huber loss&quot;,
)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>While most wrappers forward atomic measure traits appropriately, <a href="../methods/#StatisticalMeasuresBase.observation_scitype"><code>StatisticalMeasuresBase.observation_scitype(measure)</code></a> (default=<code>Union{}</code>) and <a href="../methods/#StatisticalMeasuresBase.can_consume_tables"><code>StatisticalMeasuresBase.can_consume_tables(measure)</code></a> (default=<code>false</code>) must be explicitly overloaded for measures wrapped using <code>multimeasure</code>.</p></div></div><h2 id="Improving-display-of-measures"><a class="docs-heading-anchor" href="#Improving-display-of-measures">Improving display of measures</a><a id="Improving-display-of-measures-1"></a><a class="docs-heading-anchor-permalink" href="#Improving-display-of-measures" title="Permalink"></a></h2><p>Because most useful measures are wraps of atomic measures, they don&#39;t display well:</p><pre><code class="language-julia hljs">HuberLoss()</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">multimeasure(Main.HuberLossOnScalars{Int64}(1))</code></pre><p>This can be improved using the <a href="../tools_for_implementers/#StatisticalMeasuresBase.@fix_show"><code>@fix_show</code></a> macro:</p><pre><code class="language-julia hljs">@fix_show HuberLoss::HuberLossType
HuberLoss()</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">HuberLoss(
  delta = 1)</code></pre><h2 id="Macro-shortcut-(experimental)"><a class="docs-heading-anchor" href="#Macro-shortcut-(experimental)">Macro shortcut (experimental)</a><a id="Macro-shortcut-(experimental)-1"></a><a class="docs-heading-anchor-permalink" href="#Macro-shortcut-(experimental)" title="Permalink"></a></h2><p>The entire workflow above is equivalent to the code block below, except that <code>HuberLoss</code> is also fussy and <code>MultitargetHuberLoss</code> gets an additional keyword argument <code>atomic_weights</code>, for specifying weights per component of the vector-valued target (per column if <code>y</code> is a table). The loss functions also accept <code>nothing</code> for weights or class weights.</p><p>You will need to try this in a new Julia session or change the loss name. See <a href="../tools_for_implementers/#StatisticalMeasuresBase.@combination"><code>@combination</code></a> for details.</p><pre><code class="language-julia hljs">valley(a, delta=1) = abs(a) &lt;= delta ? a^2/2 : delta*(abs(a) - delta/2)
huber(ŷ, y, delta=1) = valley(ŷ - y, delta)

using StatisticalMeasuresBase
import StatisticalMeasuresBase as API
using ScientificTypesBase

@combination(
    HuberLoss(; delta=1) = multimeasure(huber),
    orientation =  Loss(),
    observation_scitype = Continuous,
    human_name = &quot;Huber loss&quot;,
)</code></pre><h4 id="Demonstration-3"><a class="docs-heading-anchor" href="#Demonstration-3">Demonstration</a><a class="docs-heading-anchor-permalink" href="#Demonstration-3" title="Permalink"></a></h4><pre><code class="language-julia hljs">n = 10
y = vcat(fill(1, n)&#39;, fill(1, n)&#39;, fill(1, n)&#39;)
ŷ = vcat(fill(1, n)&#39;, fill(2, n)&#39;, fill(3, n)&#39;)
ŷ - y</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3×10 Matrix{Int64}:
 0  0  0  0  0  0  0  0  0  0
 1  1  1  1  1  1  1  1  1  1
 2  2  2  2  2  2  2  2  2  2</code></pre><pre><code class="language-julia hljs">delta = 10
valley(1, delta)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.5</code></pre><pre><code class="language-julia hljs">valley(2, delta)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2.0</code></pre><pre><code class="language-julia hljs">measure = MultitargetHuberLoss(delta=10, atomic_weights=[5, 4, 1])
@assert measure(ŷ, y, fill(100, n)) ≈ (5*0 + 4*0.5 + 1*2.0)/3*100</code></pre><pre><code class="language-julia hljs">API.observation_scitype(measure)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">AbstractArray{&lt;:Union{Missing, ScientificTypesBase.Continuous}}</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Overview</a><a class="docs-footer-nextpage" href="../methods/">Methods »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 4 August 2025 22:56">Monday 4 August 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
